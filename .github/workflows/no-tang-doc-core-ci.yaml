name: no-tang-doc-core CI

on:
  push:
    branches:
      - main
      - dev
      - mod/core
      - feat/core/**
    paths:
      - "no-tang-doc-core/**"
      - ".github/workflows/no-tang-doc-core-ci.yaml"
      - ".github/workflows/no-tang-doc-core-cd.yaml"
  pull_request:
    branches:
      - main
      - dev
      - mod/core
    paths:
      - "no-tang-doc-core/**"
  workflow_call:
    inputs:
      ref:
        description: Git ref (branch, tag, or SHA) to check
        required: false
        type: string
        default: ""
    secrets:
      DO_ACCESS_TOKEN:
        required: false
      DOKS_CLUSTER_NAME:
        required: false
      SPRING_DATASOURCE_URL:
        required: false
      SPRING_DATASOURCE_USERNAME:
        required: false
      SPRING_DATASOURCE_PASSWORD:
        required: false
      KEYCLOAK_ADMIN_USERNAME:
        required: false
      KEYCLOAK_ADMIN_PASSWORD:
        required: false
      KEYCLOAK_CLIENT_SECRET:
        required: false
      DO_SPACES_ACCESS_KEY:
        required: false
      DO_SPACES_SECRET_KEY:
        required: false
  workflow_dispatch: {}

defaults:
  run:
    working-directory: no-tang-doc-core

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    # Skip CI when syncing between mod/core and dev
    if: |
      !(
        (github.head_ref == 'mod/core' && github.base_ref == 'dev') ||
        (github.head_ref == 'dev' && github.base_ref == 'mod/core')
      )
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.sha }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.sha }}

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: "24"
          distribution: "oracle"
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.m2/wrapper
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml', '**/maven-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run PMD
        run: mvn -B pmd:pmd pmd:check
        continue-on-error: true

      - name: Run Checkstyle
        run: mvn -B checkstyle:check
        continue-on-error: true

      - name: Upload PMD reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: core-pmd-reports
          path: |
            no-tang-doc-core/target/pmd.xml
            no-tang-doc-core/target/site/pmd.html
          compression-level: 9

      - name: Upload Checkstyle reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: core-checkstyle-reports
          path: |
            no-tang-doc-core/target/checkstyle-result.xml
            no-tang-doc-core/target/site/checkstyle.html
          compression-level: 9

  test:
    name: Test
    runs-on: ubuntu-latest
    # Skip CI when syncing between mod/core and dev
    if: |
      !(
        (github.head_ref == 'mod/core' && github.base_ref == 'dev') ||
        (github.head_ref == 'dev' && github.base_ref == 'mod/core')
      )
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.sha }}

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: "24"
          distribution: "oracle"
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.m2/wrapper
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml', '**/maven-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build (compile only)
        run: mvn -B -DskipTests clean compile

      - name: Run tests with coverage
        run: mvn -B clean verify -Dspring.profiles.active=test

      - name: Generate Surefire HTML report
        if: always()
        run: mvn -B surefire-report:report

      - name: Upload JaCoCo coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: core-test-results
          path: |
            no-tang-doc-core/target/site/jacoco/
            no-tang-doc-core/target/site/surefire-report.html
          compression-level: 9

  deploy:
    name: Deploy
    needs: [lint, test]
    # Only deploy when:
    # 1. Both lint and test jobs succeed (CI passes)
    # 2. Push to protected branches: main, dev, or mod/core
    # 3. Push event (triggered after PR merge to protected branches)
    if: |
      needs.lint.result == 'success' &&
      needs.test.result == 'success' &&
      contains(fromJson('["main","dev","mod/core"]'), github.ref_name) &&
      github.event_name == 'push'
    uses: ./.github/workflows/no-tang-doc-core-cd.yaml
    with:
      sha: ${{ github.sha }}
      branch: ${{ github.ref_name }}
    secrets: inherit
